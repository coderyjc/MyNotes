## 事务

### 事务

事务是用户定义的数据操作系列，这些操作作为一个完整的工作单元，一个事务内的所有语句被作为一个整体，要么**全部执行**，要么**全部不执行**。

一个事务可以是一组SQL语句、一条SQL语句或整个程序，一个应用程序可以包括多个事务。

### 事务的特征（ACID）

- **原子性(Atomicity)** 事务是数据库的逻辑工作单位，事务中的操作要么都做，要么都不做。
- **一致性(Consistency)** 事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。
- **隔离性(Isolation)** 数据库中一个事务的执行不能被其它事务干扰。
- **持久性(Durability)** 也称为永久性。事务一旦提交，对数据库数据的改变是永久的。

事务的ACID特性可能遭到破坏的因素有两种：
- 多个事务并行运行时，不同事务的操作有交叉情况
- 事务在运行过程中被强迫停止。

### SQL事务处理模型

隐式事务：又称自动提交事务，每条数据操作语句都自动成为一个事务。

显式事务：有显式的开始和结束标记的事务。【ISO事务处理模型、T-SQL事务处理模型】

**ISO事务处理模型**

明尾暗头：事务的开头是隐含的，事务的结束有明确标记。

事务结束符
COMMIT：事务成功结束符
ROLLBACK：事务失败结束符

事务起始/终止位置：程序的首条SQL语句或事务结束符后的语句；在程序正常结束处或COMMIT语句处成功终止；在程序出错处或ROLLBACK处失败终止。

```sql
UPDATE 支付表
SET 帐户总额页 = 帐户总额 - n
WHERE 帐户名 = 'A'
UPDATE 支付表
SET 帐户总额 = 帐户总额 + n
WHERE 帐户名 = 'B'
COMMIT
```

**T-SQL事务处理模型**
 每个事务都有显式的开始和结束标记。

事务的开始标记是：`BEGIN TRANSACTION | TRAN`

事务的结束标记为：

```
COMMIT [TRANSACTION | TRAN ]
ROLLBACK [ TRANSACTION | TRAN ]
```

```sql
BEGIN TRANSACTION

UPDATE 支付表
SET 帐户总额页 = 帐户总额 - n
WHERE 帐户名 = 'A'
UPDATE 支付表
SET 帐户总额 = 帐户总额 + n
WHERE 帐户名 = 'B'

COMMIT
```

