## 数据库故障

两种：数据库本身被破坏或者数据库没有被破坏但数数据不正确。

### 事务内部的故障

 事务内部故障指非预期的，不能由应用程序处理。例如：运算溢出，违反了某些完整性限制等。

事务故障的恢复：事务故障意味着事务没有达到预期的终点，数据库可能处于不正确状态，因此，要在不影响其它事务运行的情况下，撤销该事务已经做的对数据库的修改，使得该事
务好像根本没有运行一样。

事务故障的恢复操作：撤销事务（UNDO）

### 系统故障

系统故障称为软故障，是指造成系统停止运转的任何事件，使得系统要重新启动。 例如突然断电。

 带来的问题：
- 整个系统的正常运行突然被破坏
- 所有正在运行的事务都非正常终止
- 数据库缓冲区的信息全部丢失；不破坏数据库。

发生系统故障时，事务未完成：强行撤消(UND0)所有未完成事务。

发生系统故障时，事务已提交，但缓冲区中的信息尚未完全写回到磁盘上：重做（REDO）所有已提交的事务。

### 其他故障

介质故障（磁盘损坏）：装入数据库发生介质故障前某个时刻的数据副本。重做自此时始（副本备份时刻）的所有成功事务，将这些事务已提交的结果重新记入数据库。

病毒：查杀病毒，安装防火墙或者实时监控软件。恢复数据库

## 数据库备份

恢复操作的基本原理：冗余

利用存储在系统其它地方的冗余数据来重建数据库中已被破坏或不正确的那部分数据

数据的恢复涉及两个关键问题：
1. 如何建立冗余数据：备份
2. 如何利用这些冗余数据实施数据库恢复。

数据备份是指定期或不定期地对数据库数据进行复制。备份的介质可以用磁盘。

### 备份的内容

备份数据（数据转储）

1. 表（结构），包含系统表、用户定义的表
2. 数据库用户（包括用户和用户操作权）
3. 用户定义的数据库对象和数据库中的全部数据
4. 备份日志（登记日志文件）

### 备份频率

要考虑两个因素：
- 出现故障时，允许丢失的数据量的大小。
- 数据库的事务类型（读多还是写多）以及事故发生的频率（经常发生还是不经常发生）。

通常情况下，数据库可以每周备份一次，事务日志可以每日备份一次。

对于一些重要的联机事务处理数据库，可以每日备份，事务日志则每隔数小时备份一次。

### 备份数据（数据转储）

数据转储：转储是指DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程，备用的数据称为后备副本或后援副本。

如何使用：数据库遭到破坏后可以将后备副本重新装入；重装后备副本只能将数据库恢复到转储时的状态。

备份方法：
1. 静态转储与动态转储
2. 海量转储与增量转储

==静态转储==：在系统中无运行事务时进行的转储操作，转储期间不允许对数据库的任何存取、修改活动。得到的是数据一致性的副本 。实现简单但降低了数据库的可用性。

==动态转储==：转储操作与用户事务并发进行，允许对数据库进行存取或修改。不会影响事务的运行，但不能保证副本中的数据正确有效。

==海量转储==：每次转储全部数据库。

==增量转储==：只转储上次转储后更新过的数据。

海量转储与增量转储比较：
- 从恢复角度看，使用海量转储得到的后备副本进行恢复往往更方便；
- 但如果数据库很大，事务处理又十分频繁，则增量转储方式更实用更有效。

![[assets/Pasted image 20240311162209.png]]

## 登记日志文件

### 日志文件的格式和内容

日志文件(log)：用来记录事务对数据库的更新操作的文件。

日志文件的格式
- 以记录为单位的日志文件；
- 以数据块为单位的日志文件。

以记录为单位的日志文件（日志记录的组成）：
1. 事务标识
2. 事务的开始标记
3. 事务的结束标记
4. 事务的所有更新操作（类型、对象、更新前旧值、更新后新值）

以数据块为单位的日志文件的内容：
1. 事务标识
2. 被更新的数据块（更新前和更新后的）

### 日志文件的作用

- 进行事务故障恢复；
- 进行系统故障恢复；
- 协助后备副本进行介质故障恢复。

### 登记日志文件

登记的次序严格按并行事务执行的时间次序

必须**先写日志文件，后写数据库**：
- 写日志文件操作：将修改的记录写到日志文件
- 写数据库操作：把对数据的修改写到数据库中。

## 数据库恢复

恢复数据库是指将数据库从错误描述状态恢复到正确的描述状态（最近的正确时刻）的过程。

### 恢复策略

**事务故障的恢复**

事务故障：事务在运行至正常终止点前被终止。

恢复方法：利用日志文件撤消此事务已对数据库进行的修改。事务故障的恢复由系统自动完成，对用户是透明的，不需要用户干预。

步骤：
1. 反向扫描文件日志，查找该事务的更新操作。
2. 对该事务的更新操作执行逆操作。
3. 继续反向扫描日志文件，查找其他更新操作，同样处理。
4. 直至读到此事务的开始标记，事事务故障恢复就完成了。

**系统故障的恢复**

系统故障造成数据库不一致状态的原因：
- 未完成事务对数据库的更新已写入数据库
- 已提交事务的更新还留在缓冲区没来得及写入数据库

恢复方法：
1. 撤销故障发生时未完成的事务；
2. 重做已完成的事务。

系统故障的恢复由系统在重新启动时自动完成。
1. 正向扫描日志文件：
	- 重做队列 : 在故障发生前已经提交的事务；
	- 撤销队列 : 故障发生时尚未完成的事务；
2. 对撤销队列事务进行撤销处理
	- 反向扫描日志文件，对每个撤销事务执行逆操作。
3. 对重做队列事务进行重做处理
	- 正向扫描日志文件，对每个重做事务重新执行。

**介质故障的恢复**

1. 装入最新的后备数据库副本，使数据库恢复到最近一次转储时的一致性状态。
	- 利用静态转储的数据库副本，装入数据库后，系统处于一致性状态
	- 利用动态转储的数据库副本，还须同时装入转储时刻的日志文件副本，才能将数据库恢复到一致性状态。
2. 装入有关的日志文件副本，重做已完成的事务。
	- 首先扫描日志文件，找出故障发生时已提交的事务的标识，将其记入重做队列。
	- 然后正向扫描日志文件，对重做队列中的所有事务进行重做处理。

介质故障的恢复需要DBA介入。
- DBA的工作：重装最近转储的数据库副本和有关的各日志文件副本；
- 执行系统提供的恢复命令。

具体的恢复操作仍由DBMS完成。

### 恢复技术

**利用备份技术**

定期备份； 利用备份文件将数据库恢复到备份时刻的状态。

**利用事务日志**

利用事务日志可以恢复执行不完整的事务；恢复数据库到事务执行前的状态；系统自动完成。

**数据库镜像**

问题：
- 介质故障对系统影响严重，影响数据库的可用性。
- 介质故障恢复比较费时；
- 为预防介质故障，DBA必须周期性地转储数据库。

解决方案：数据库镜像（Mirror）

DBMS自动把整个数据库或关键数据复制到另一个磁盘上。
DBMS自动保证镜像数据与主数据库的一致性。
当主数据库更新时，DBMS自动把更新后的数据复制过去。

用途：
没有出现故障时：数据库镜像可用于并发操作。
出现介质故障时：
- 可由镜像磁盘继续提供使用
- 同时DBMS自动利用镜像磁盘数据进行数据库的恢复；
- 不需要关闭系统和重装数据库副本

频繁地复制数据自然会降低系统运行效率。只对关键数据和日志文件镜像，而不是对整个数据库进行镜像。