# tmall users repurchase forecast

复购率的两种计算方法

$$复购率=\frac{重复购买用户数量}{用户样本数量}$$

$$复购率＝\frac{重复重复购买行为次数（或者交易次数）}{用户样本数量}$$

### 用户日志表

| Data Fields | Definition                                       |
| ----------- | ------------------------------------------------ |
| user_id     | 用户id                                           |
| item_id     | 商品id                                           |
| cat_id      | 商品类目id                                       |
| seller_id   | 商家id                                           |
| brand_id    | 品牌id                                           |
| time_stamp  | 行为发生时间                                     |
| action_type | 操作类型｛0、1、2、3｝表示点击、加购、购买、收藏 |

```python
user_log = pd.read_csv("../data/user_log_format1.csv")
user_log.head(5)
```

```text
0,328862,323294,833,2882,2661.0,829,0
1,328862,844400,1271,2882,2661.0,829,0
2,328862,575153,1271,2882,2661.0,829,0
3,328862,996875,1271,2882,2661.0,829,0
4,328862,1086186,1271,1253,1049.0,829,0
```

### 用户特征表

| Data Fields | Definition                                                                                                                                |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| user_id     | 用户id                                                                                                                                    |
| age_range   | 顾客（用户）年龄范围：1表示<18；2表示[18，24]；3表示[25，29]；4表示[30，34]；5表示[35，39]；6表示[40，49]；7and8表示≥50；0andNull表示未知 |
| gender      | 0表示女性、1表示男性、2和null表示未知                                                                                                     |

```python
user_info = pd.read_csv("../data/user_info_format1.csv")
user_info.head(5)
```

```text
0,376517,6.0,1.0
1,234512,5.0,0.0
2,344532,5.0,0.0
3,186135,5.0,0.0
4,30230,5.0,0.0
```


### 训练数据和测试数据

| Data Fields | Definition               |
| ----------- | ------------------------ |
| user_id     | 用户id                   |
| merchant_id | 商家id                   |
| label       | 1表示复购、0表示不是复购 |

```python
train_data = pd.read_csv("../data/train_format1.csv")  
train_data.head(5)
```


```text
0,34176,3906,0
1,34176,121,0
2,34176,4356,1
3,34176,2217,0
4,230784,4818,0
```


```python
test_data = pd.read_csv("../data/test_format1.csv")  
test_data.head(5)
```

```text
0,163968,4605,NaN
1,360576,1581,NaN
2,98688,1964,NaN
3,98688,3645,NaN
4,295296,3361,NaN
```

### 评估指标

AUC为本赛题的评估指标

$$AUC={ \sum_{i \in positive Class}rank_{i} - {M(1+M) \over 2} \over {M*N}}$$

含义：
1. 只反映模型对正负样本排序能力的强弱，对score的大小和精度没有要求。
2. AUC越高，模型排序能力越强。理论上，当模型把所有正样本都排在负样本之前时，AUC为1.0，是理论的最大值。例如，有100个样本，其中有20个正样本，80个负样本。我们通过模型给每个样本打分，如果每个正样本的score/probability都高于所有负样本，则AUC为最高值1.0。

调用方法：

```python
import numpy as np  
from sklearn.metrics import roc_auc_score

y_true = np.array([0, 0, 1, 1])  
y_scores = np.array([0.1,0.4,0.35,0.8])  
  
roc_auc_score(y_true, y_scores)
```

```text
0.75
```

### 分析

本题是二分类问题。

本体要求预测新用户在6个月内再次从同一家店购买商品的概率。

计算方法：

sklearn分类器的`predict`用于计算预测的标签，`predict_proba`用于计算属于该标签的概率

```python
from sklearn.linear_model import LogisticRegression  
import numpy as np  
  
x_train = np.array([[5,4,2],[8,3,4],[2,5,6]])  
y_train = np.array([0,1,1])  
  
x_test = np.array([[2,2,2],[2,3,4],[4,5,6]])  
  
clf = LogisticRegression()  
clf.fit(x_train, y_train)  
  
print(clf.predict(x_test))  
print(clf.predict_proba(x_test))
```

```text
[0 1 1]

[[0.77789602 0.22210398]
 [0.40328208 0.59671792]
 [0.08757153 0.91242847]]
```

```ad-question
title: 如何进行特征提取？

1. 从用户历史行为出发
2. 从店铺历史行为出发
3. 从用户和店铺的历史行为出发

用户历史行为根据user_id进行分组，统计购买、点击、喜欢、购物车、商品ID、商品种类、商品品牌的个数（每个用户）
对用户历史行为的seller_id进行分组,统计上述特征的个数（每个商家）
对用户历史行为的uscrjd和scllerld进行分组’统计上述特征的个数（每个用户+店铺的组合）
```



