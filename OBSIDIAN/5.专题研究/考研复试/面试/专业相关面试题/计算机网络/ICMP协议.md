### ICMP协议

网际控制报文协议（Intermnet Control Message Protocol，ICMP）用来让主机或路由器报告差错和异常情况。ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。ICMP是网络层协议。

ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文。

**ICMP差错报告报文**用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况。共有以下5种常用的类型：

1. **终点不可达**。当路由器或主机**不能交付数据报**时，就向源点发送终点不可达报文。
2. **源点抑制**。当路由器或主机**由于拥塞而丢弃数据报**时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。
3. **时间超过**。当路由器收到**生存时间为零的数据报**时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
4. **参数问题**。当路由器或目的主机收到的数据报的**首部中有的字段的值不正确**时，就丢弃该数据报，并向源点发送参数问题报文。
5. **改变路由**（重定向）。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

不应发送ICMP差错报告报文的几种情况如下：
1. 对ICMP差错报告报文不再发送ICMP差错报告报文。
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。
3. 对具有组播地址的数据报都不发送ICMP差错报告报文。
4. 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

**ICMP询问报文**有4种类型：回送请求和回答报文、时间戳请求和回答报文、地址掩码请求和回答报文、路由器询问和通告报文，最常用的是前两类。

ICMP的两个常见应用是分组网间探测PING（用来测试两台主机之间的连通性）和Traceroute（UNTX中的名字，在Windows中是Tracert，可以用来跟踪分组经过的路由）。其中PING使用了ICMP回送请求和回答报文，Traceroute（Tracert）使用了ICMP时间超过报文。

注意：PING工作在应用层，它直接使用网络层的ICMP，而未使用传输层的TCP或UDP。Traceroute/Tracert工作在网络层。